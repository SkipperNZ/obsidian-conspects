[[CV]]



# Лекция 4 (Детект 1 rcnn, mtcnn) 

![[Pasted image 20220428143158.png]]


Различия с задачей классификаци:
1) на картинке может быть несколько объектов разных классов, а может и не быть ни одного
2) на картинке может быть много объектов однго класса.
3) Требуется локализовать объект на картинке предсказаным баундинг боксом (bbox)

Примеры детекции: 
1) Детекция лица, автофокус камеры распознование лиц(сначала поиск лица, потом его детекция)
2) Повозки (машины/роботы/дроны)
3) детекция людей

**Сложности при детектировании**
1) Как локализовать объекты? Как предсказать баундинг боксы 
2) Баундинг боксы могут иметь различный размер. 
3) простой ресайз или центр-кроп в большинстве случаев не работает
4) интра-классовая вариация (объекты одного класса могут выглядеть по разному и иметь разный размер)
5) объекты могут пересекаться на картинке
6) как оценить качство детекции

**Как проверить точность локализации?**
Intersection over Union (IoU)
![[Pasted image 20220428205206.png]]

Если IoU > трешхолд (обычно 0.5) : **True Positive**
Иначе: **False Positive**
Если нет предикта для существующего объекта: **False Negative**

Это по сути мера Жокарда надо пикселями баундинг боксов (мера схожести множеств)

## Алгоритмы детекции
**олдскульные подходы**
1) Histograms of Oriented Gradients (HOG)
2) Haar Cascades
3) SIFT
Их идея в скользящем окне + пирамида из картинок


**Нейросетевые подходы**

Обзор:
1. Region-based (двухшаговые детекторы):
	a. RCNN
	b. Fast RCNN
	c. Faster RCNN
2. One-shot (одношаговые детекторы):
	a. SSD
	b. YOLO
3. Cascaded Detectors:
	a. MTCNN
	b. ...
4. Transformer-based
	a. DETR
	b. ...
	

### RCNN (Regions with CNN features)
Идея такая:
Есть какая то нейросеть которая может делать классификацию картинок (на входе картинка - на выходе распределение вероятностей над классами)
Потом можно пройтись этой нейросетью скользящим окном, получить какое то распределение над классами.
Это не очень эфективно, поэтому можно немного упростить задачу и сначала оставить только те регионы изображения, которые могут в себе что то содержать
Такие регионы, которые могут сожержать(или нет) какой ни будь объект называются **region proposals**  и есть старый уже неиспользуемый алгоритм для их поиска selective  search
![[Pasted image 20220429014026.png]]

Соответственно идея такая: 
берём  и применяем селектив серч к картинке и получаем набор пропоузенов. потом каждый регион мы вырезаем прямоугольником и прогоняем его через классификационную нейронку и дообрабатываем результат с помошью NMS
![[Pasted image 20220429014637.png]]

**NMS - Non Maximum Suppression**
на самом деле пропоузелов довольно много, и для каждого объекта будет предсказано много баундинг боксов. 
Надо немного постобработать результат детекции 
Давайте попробуем взять и сильно пересекающиеся баундинг боксы объединить  в один
**![](https://lh5.googleusercontent.com/JBKWJLCBZ1MW6fg0elRFdZoA6OkUqjFCxrstAkvGlCX_TczPnr7Aff_PdWTXCbzp_JRELxPc-Z9zzd7QduqvsMgqW7DoKWNW_IkeoseIqbZIu8w7TxCdnsYMjwlBwh1sTG2dt7kfpfVIAPY0tNrmBQ)**

NMS алгоритм:
1) Все баундинг боксы которые предсказались надо отсортировать по их скору в  порядке убывания и сохраняем их в список L.
2) итерируемся по списку L:
	a. Берём первый бокс из L
	b. считаем IoU со всеми остальными боксами из L
	c. Оставляем только те, которые имеют IoU меньше какого то порога. 
	d. повторяем для остальных боксов

Еще немного деталей **RCNN**
1)  **Classification CNN training**
	а) Используем предобученую нейросеть  для классификации Pre-trained CNN for image classification (authors use AlexNet trained on ImageNet)
	b) У неё заменяем последний классификационный слой который будет предсказывать нам N+1 класс "background" который означает что никакого объекта там нет
	c) Далее генерируется датасет с кропами объектов
	d) перетренировывается сетка 
2) **Class-specific SVM** (тут лектор не очень вспомнил что это, но так как это всё давно устарело, то собственно не важно)
	a) Allows to assign multiple labels to a region at test time.
	b) Trained on CNNs features from pre-last fully connected layer (before classification layer).

**Плюсы и минусы:**
Плюсы:
1) Первый "хороший" детектор объектов (53.7% mAP on PASCAL VOC 2010)

Минусы:
1) Очень медленный 13с/картинку на гпу или 53с/картиеку на цпу. ~2000 порпосалов. Дублируются расчеты в случае перекрытия порпосалов (без использования шаринга вычислений)
2) сжимает картинку до стандартного размера без учета масштаба и соотношения сторон.
3) Обучение требует как вычислительных ресурсов, так и памяти.
4)  Несколько этапов обнаружения(селектив серч/нейросеть/нмс), что не очень удобно.

Как мы можем ускорить RCNN?

Что мешает нам применять CNN к картинке произвольного размера?
Собственно полносвязный слой на выходе, туда придёт некорректное число данных, в то время как сами свёртки инвариантны к размеру.
Можно от них избавится переписав операции

Тут мы подходим к идее полносвёрточных нейросетей.

**Как можно имитировать полносвящный слой с помощью Conv2d?**
Делали так: 
Есть какая то свёртка CxHxW, дальше она вытягивается в вектор 1\*C\*H\*W    и уже он суётся в линейный слой
![[Pasted image 20220429024826.png]]

делаем свёртку с кернелом HxW и она нам вытянет всё в другую свёртку размером Rx1x1 
![[Pasted image 20220429025659.png]]

Что будет если мы классифицируем этой сеткой картинку в 2 раза большего размера: 
![[Pasted image 20220429031444.png]]

То на выходе получится не просто вектор 1000x1 а тензор с 1000 каналами 
![[Pasted image 20220429031609.png]]

Как нам ускорить RCNN?

### Fast RCNN
![[Pasted image 20220429032347.png]]

Тут мы прогоняем картинку через инференс всего 1 раз
Но пропозалов всё равно будет много. 

То есть у нас есть баудинг бокс на картике, мы его можем спроецировать на фича-мапу(почему то на картинке она слева и снизу) и считаем что фичи в рамочке - это фичи выделеного региона с картинки. 
И мы хотим этот регион проклассифицировать.
непонятно на этой хитмапе один или несколько объектов, какого они размера. И мы бы хотели к этой штуке применить какую нибудь полносвязную нейросеть.
Проблема в том, что от размера proposal этот регион на хитмапе будет разного размера. 
Мы можем применить к этому региону операцию пулинга. 
![[Pasted image 20220429040154.png]]
в результате получили тензор 2х2 с максимальными значениями (max pooling)

Этот тензор уже фиксированного размера 
Дальше уже привычным образом вытягиваем это в один вектор и применяем классификацию. 

1) Такая же как и раньше region proposal техника (selective search).
2) Суём всю картинку в полносвёрточную нейронку и получаем карту фичей с размером CxWxH.
3) Для каждого proposal:
	a) вырезаем регион из фича-мапы отваечающий этому  proposal и используем Rol Pooling, который выдаёт фича-мапу фиксированной размерности по этому региону.  вот такого приблизительно размера (W_image/w_proposal) and (H_image/h_proposal).
	b) Скармливаем запуленые регионы в полносвязные слои и предсказываем  классификацию и баундинг бокс регрессию (Δx, Δy, k_h, k_w)
4) применяем NMS

**Что такое Bbox regression**

Рол пуллинг может нам выдавать довольно неточные пропозалы, и мы бы хотели уметь их уточнять. 
![[Pasted image 20220429041528.png]]
Зная вот эти 4 параметра мы можем приводить один бокс к другому. 

Идея такая: давайте нейросетью будем предсказывать эти 4 числа которые будут говорить как нужно пропозал со входа нужно сместить и растянуть что бы объект попадал в него лучше.


Еще немного деталей **Fast RCNN**
1) Rol Pooling слой - дифференцируемый, поэтому Fast RCNN можно тренировать end-to-end.
2) одновременно обучается и классификация и Bbox регрессия и оптимизируются совместно
3) Свёртки применяются один раз, но полносвязные слои применяются к каждому запуленому региону каждого пропозла, и авторы сделали так use truncated SVD on fully connected layers weight matrices => 30% speedup.
4) VGG16 instead of AlexNet.

Основной недостаток: region proposal техника


Хотелось бы избавится от селектив серча.
Давайте натренируем CNN которая будет лучше предсказывать region proposal.

### Faster RCNN
1) Дополнительная сетка для генерации пропосалов на базе полносверточной части - Region Proposal Network (RPN).
2) Концепция Anchor Boxes с различными размерами и соотношениями сторон
3) RPN предсказывает  “objectness” есть там какой то объект или нет
4) NMS  применяется к сгенерированым пропозалам. Соответствующие области свёрнутой фича мапы передаются в rol pooling слой  и результат передаётся в Fast RCNN голову.
![[Pasted image 20220429043824.png]]

**И со слов лектора:**
Идея такая, возьмем fast RCNN и прикрутим к ней какую то более клёвую схему для выделения пропозалов которые будут более качественные, и будут предсказываться нейросетью.

У нас тут был тензор, который содержит в себе хорошие фичи нашей картинки, которые актуальны для детекции, давайте этот же тензор попробуем использовать что бы и пропозалы сразу от туда вытащить. 
![[Pasted image 20220429142011.png]]

Схема такая (снизу вверх):
Была картинка, мы прогнали её через свёрточные слои, получились какие то фича мапы.
Мы эти фича мапы подаём в отдельную небольшую сеть, которая называется RPN (Region Proposal Network) которая каким то образом нам сгенерирует хорошие пропозалы
Потом из уже суём в Fast RCNN
![[Pasted image 20220429142239.png]]

Вопрос: 
Каким образом с помощью нейросети предсказывать пропозалы?
Тут нам понадобится такая концепция как Anchor Boxes
Идея такая: 
Мы хотим взять и накидать на картинку каких то априорно заданых до обучения баундинг боксов для разных регионов изображения и научится предсказывать есть ли в них что то или нет, с помощью нейросети.
![[Pasted image 20220429142906.png]]
Если мы научимся так делать, то мы сможем получать пропозалы.
RPN предсказывает  “objectness” есть там какой то объект или нет
И далее можно применить NMS применить к сгенерированым пропозалам из RPN и получить их меньшее количество.

**Что такое Anchor Boxes**
Есть картинка, мы скажем, что на ней есть какая то сетка из каких то регионов
![[Pasted image 20220429143912.png]]

Потом скажем, что с каждым регионом ассоциируется баундинг боксы определённого размера и конфигурации 
![[Pasted image 20220429145014.png]]

И мы скажем то что если мы нарисуем банндинг боксы всех конфигураций для каждой области изображения увидим что эти баундинг боксы довольно плотно эту картинку покрывают. 
Идея простая:
Если мы научимся предсказывать “objectness”  в этих anchor  box'ах мы по факту можем сказать есть ли что то в данной области картинки или нет и выдаём anchor box как пропозал
![[Pasted image 20220429145327.png]]

Как теперь научится предсказывать вот в этих anchor  box'ах  существование какого то объекта.

Посмотрим на нашу картинку с сеткой 3x4. 
Что если мы возьмем и каждую локацию вокруг точек сетки ассоциируем с суперпикселем в тензоре нейросети.
То есть мы попросим RPN предсказать тензор размерности 3x4x(N+1)(N+1 - есть класс или нет класса)  и посто ассоциируем какой то анекер бокс со значением в этом тензоре. 

Как конкретно это делается?

Есть картинка, применили к ней какую то свёрточную сеть и получили тензор с признаками. 
Дальше применяем RPN
С помощью свёрток, получаем тензор размерности типа такой 3x4x(N+1) - (верхняя часть в рамочке RPN)
Кроме этого мы можем еще предсказать тензор с регрессией, той же размерности умноженной на 4
Затем мы отбираем только те анкербоксы, которые больше какого либо порога. и смещаем и растягиваем анкербокс с помощью предсказаной для неё регрессии 
Дальше уже суем всё в голову от фаст РСНН
![[Pasted image 20220429165036.png]]

Чем плоха эта схема. 

У нас анкер боксы примерно одного размера и таким образом мы можем детектировать размеры так же примерно одного размера. 
Либо большие боксы сильно пересекаются, либо маленькие слишком далеко друг от друга.
For each “location” we have same number of big and small boxes. Smaller boxes are more “sparse”. But the image can fit more small objects than big ones. 

Поэтому можно делать детекцию на разных масштабах 
будет не одна сетка(как была 3х4 а уже несколько)
![[Pasted image 20220429171414.png]]

Пример
![[Pasted image 20220429171503.png]]

1) предыдущий CNN тензоры  используется в генерации пропозалов (не только последний маленький выходной)
2) пропозалы из разных масштабов хранятся в одном массиве
![[Pasted image 20220429171724.png]]


Детали **Faster RCNN**

1) В какомто смысле RPN это **“attention”** механизм для всей сети 
2) Классификация и регрессия предсказываются в RPN в **superpixel-wise** манере ( одному региону соответствует какой то суперпиксель)
3) Досихпор используется и есть её расширение называемое **Mask RCNN** которое надстройка над Faster RCNN с resnet для свёрточный части 
4) **R-FCN** тоже какое то улучшение 


Сравнение этих 3х архитектур 
![[Pasted image 20220429172328.png]]

Более хорошие архитектуры
1.  R-FCN
2.  FCOS
3.  Cascade-RCNN
+   MaskRCNN


### Метрики

Основная - mean Average Precision (mAP). Не путать с mAP@K metric в задаче ранжирования.
![[Pasted image 20220429172643.png]]

По х -рекол, по у - пресижн
меня порог(уверенность детектора) по которому мы берём тру позитивы и фолспозитивы 

Оранжевая линия -  пресижн/рекол кривая 

Зеленая линия - Максимальный пресижн который мы можем получить на специфического уровня рекола.

![[Pasted image 20220429173801.png]]
Average Precision for specific class: average maximum Precision we can get for Recall values in [0.0, 0.1, …, 0.9, 1.0 ]

Average Precision  - это как раз площадь под этой кривой
Это средний максимальный пресижн который модем получить для разнличных значений рекола
Для каждого класса усредняем.

